<!doctype html>
<html>
<head>
  <!--
    back/public/run.html
    - run batch, undo month, recalculate, run for single employee
    - Calls API endpoints under /api/payroll
  -->
  <meta charset="utf-8" /><title>Run Payroll</title></head>
<body>
  <h1>Run Payroll</h1>
  <label>Month (YYYY-MM): <input id="month" value="2026-01" /></label>
  <label>Payroll Group:
    <select id="group" title="Select payroll group: 'no-cut' will skip cut rules (profile $20 & 10-day holding).">
      <option value="cut">cut</option>
      <option value="no-cut">no-cut</option>
      <option value="monthly">monthly</option>
    </select>
  </label>
  <p><small><strong>no-cut</strong>: skip profile $20 deduction and 10-day holding; only static deductions and savings will apply.<br>
  <strong>monthly</strong>: pays full monthly base and applies any `monthly_debt` entries at month end (when days reach 30). Enter debts during the month as deduction records with type `monthly_debt` and the same YYYY-MM to have them applied at month end.</small></p>
  <button id="run">Run for Group</button>
  <button id="undo">Undo Month</button>
  <button id="recalc">Recalculate</button>

  <h2>Monthly Debts</h2>
  <label>Month to view: <input id="debtsMonth" value="2026-01" /></label>
  <label>Filter employee name: <input id="filterEmployeeName" placeholder="e.g. Alice" /></label>
  <label>Page size: <input id="pageSize" type="number" value="10" min="1" max="100" /></label>
  <button id="loadDebts">Load Monthly Debts</button>
  <div id="debtsList"></div>

  <!-- Confirmation modal -->
  <div id="confirmModal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
    <div style="background:#fff;padding:16px;border-radius:6px;max-width:420px;margin:auto;">
      <p id="confirmMessage">Are you sure?</p>
      <button id="confirmYes">Yes</button>
      <button id="confirmNo">No</button>
    </div>
  </div>
  <h2>Single Employee</h2>
  <label>Employee ID: <input id="empId" /></label>
  <button id="runEmp">Run for Employee</button>

  <h2>Create Monthly Debt</h2>
  <label>Employee ID: <input id="debtEmpId" /></label>
  <label>Amount: <input id="debtAmount" type="number" /></label>
  <label>Month (YYYY-MM): <input id="debtMonth" value="2026-01" /></label>
  <label>Reason: <input id="debtReason" /></label>
  <button id="createDebt">Create Monthly Debt</button>

  <pre id="out"></pre>

  <script>
    const out = document.getElementById('out');
    function log(x){ out.textContent = JSON.stringify(x, null, 2); }

    document.getElementById('run').onclick = async () => {
      const month = document.getElementById('month').value;
      const group = document.getElementById('group').value;
      const res = await fetch('/api/payroll/generate', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ month, payroll_group: group }) });
      log(await res.json());
    }

    document.getElementById('undo').onclick = async () => {
      const month = document.getElementById('month').value;
      const res = await fetch('/api/payroll/undo', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ month }) });
      log(await res.json());
    }

    document.getElementById('recalc').onclick = async () => {
      const month = document.getElementById('month').value;
      const group = document.getElementById('group').value;
      const res = await fetch('/api/payroll/recalculate', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ month, payroll_group: group }) });
      log(await res.json());
    }

    document.getElementById('runEmp').onclick = async () => {
      const month = document.getElementById('month').value;
      const employeeId = document.getElementById('empId').value;
      const res = await fetch('/api/payroll/generate/employee', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ month, employeeId }) });
      log(await res.json());
    }

    document.getElementById('createDebt').onclick = async () => {
      const employeeId = document.getElementById('debtEmpId').value;
      const amount = parseFloat(document.getElementById('debtAmount').value);
      const month = document.getElementById('debtMonth').value;
      const reason = document.getElementById('debtReason').value;
      const res = await fetch('/api/payroll/deductions', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ employeeId, type: 'monthly_debt', amount, month, reason }) });
      log(await res.json());
    }

    // Pagination state
    let debtsCurrentPage = 1;
    async function loadDebtsPage(page = 1) {
      const month = document.getElementById('debtsMonth').value;
      const pageSize = parseInt(document.getElementById('pageSize').value) || 10;
      const employeeName = document.getElementById('filterEmployeeName').value || '';
      const res = await fetch(`/api/payroll/deductions?month=${encodeURIComponent(month)}&type=monthly_debt&page=${page}&limit=${pageSize}${employeeName ? `&employeeName=${encodeURIComponent(employeeName)}` : ''}`);
      const payload = await res.json();
      const list = payload.data || [];
      const container = document.getElementById('debtsList');
      if (!list || list.length === 0) {
        container.innerHTML = '<p>No monthly debts found for this month.</p>';
        return;
      }
      debtsCurrentPage = payload.page || page;
      const rows = list.map(d => `
        <div data-id="${d._id}" style="border:1px solid #ddd;padding:8px;margin:4px;">
          <div><strong>ID:</strong> ${d._id}</div>
          <div><strong>Employee:</strong> ${d.employee && d.employee.name ? d.employee.name : (d.employee && d.employee._id ? d.employee._id : d.employee)}</div>
          <div><strong>Amount:</strong> <input class="debt-amount" value="${d.amount}" /></div>
          <div><strong>Reason:</strong> <input class="debt-reason" value="${d.reason || ''}" /></div>
          <button class="save-debt">Save</button>
          <button class="delete-debt">Delete</button>
        </div>
      `).join('');
      // Pagination controls
      const pageControls = `
        <div style="margin:8px 0;">
          <button id="prevPage">Prev</button>
          <span> Page <strong>${debtsCurrentPage}</strong> of <strong>${payload.pages}</strong> </span>
          <button id="nextPage">Next</button>
        </div>
      `;
      container.innerHTML = pageControls + rows;

      // Attach handlers
      container.querySelectorAll('.save-debt').forEach(btn => btn.addEventListener('click', async (e) => {
        const node = e.target.closest('[data-id]');
        const id = node.getAttribute('data-id');
        const amount = parseFloat(node.querySelector('.debt-amount').value);
        const reason = node.querySelector('.debt-reason').value;
        const r = await fetch(`/api/payroll/deductions/${id}`, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ amount, reason }) });
        log(await r.json());
        loadDebtsPage(debtsCurrentPage);
      }));

      // Delete now uses confirmation modal
      container.querySelectorAll('.delete-debt').forEach(btn => btn.addEventListener('click', async (e) => {
        const node = e.target.closest('[data-id]');
        const id = node.getAttribute('data-id');
        showConfirm(`Delete deduction ${id}?`, async (confirmed) => {
          if (!confirmed) return;
          const r = await fetch(`/api/payroll/deductions/${id}`, { method: 'DELETE' });
          log(await r.json());
          loadDebtsPage(debtsCurrentPage);
        });
      }));

      document.getElementById('prevPage').onclick = () => { if (debtsCurrentPage > 1) loadDebtsPage(debtsCurrentPage - 1); };
      document.getElementById('nextPage').onclick = () => { if (debtsCurrentPage < payload.pages) loadDebtsPage(debtsCurrentPage + 1); };
    }

    document.getElementById('loadDebts').onclick = () => loadDebtsPage(1);
    // Simple modal-confirm implementation
    function showConfirm(message, cb) {
      const modal = document.getElementById('confirmModal');
      const msg = document.getElementById('confirmMessage');
      const yes = document.getElementById('confirmYes');
      const no = document.getElementById('confirmNo');
      msg.textContent = message;
      modal.style.display = 'flex';
      function cleanup() {
        modal.style.display = 'none';
        yes.removeEventListener('click', onYes);
        no.removeEventListener('click', onNo);
      }
      function onYes() { cleanup(); cb(true); }
      function onNo() { cleanup(); cb(false); }
      yes.addEventListener('click', onYes);
      no.addEventListener('click', onNo);
    }
  </script>
</body>
</html>